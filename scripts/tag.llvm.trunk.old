#!/bin/bash

build_dir="../build"
clang_dir_name="clang"
lld_dir_name="lld"


# Filetypes to recognize
file_suffix="\
c \
cpp \
h \
hpp \
inc \
"

# Directories to scan for interesting files 
first_level_dirs="\
lib \
include \
unittests \
tools/$clang_dir_name/lib \
tools/$clang_dir_name/include \
tools/$clang_dir_name/unittests \
$build_dir/lib/IR \
$build_dir/lib/LibDriver \
$build_dir/lib/Target \
$build_dir/tools/cce-ld \
$build_dir/tools/$clang_dir_name/include/clang \
$build_dir/tools/$clang_dir_name/lib/Basic \
$build_dir/tools/$lld_dir_name \
$build_dir/tools/llvm-config \
$build_dir/unittests/Option \
"

echo "Using ctags from $(which ctags)"
echo "Using cscope from $(which cscope)"
# If directory contains at least type in $file_suffix, print the directory to stdout
find_interesting_subdirs() {
  typeset dir=$1
  typeset idirs=
  for subdir in $(find $dir/ -type d); do
    found_file=0
    for suffix in $file_suffix; do
      if [ -n "$(ls $subdir/*.$suffix 2>/dev/null)" ]; then
        found_file=1
        break
      fi
    done
    if [ -d $subdir/.git ]; then 
      found_file=1
    fi
    if [ $found_file -eq 0 ]; then 
      continue
    fi
    echo $subdir
  done
}

rm -f tags
rm -f cscope*.out

all_dirs=
num_dirs=0
#all_dirs_for_cscope=
for fldirs in $first_level_dirs; do
  if [ ! -e $fldirs ]; then
    continue
  fi
  idirs=$(find_interesting_subdirs $PWD/$fldirs)
  for dir in $idirs; do
    rm -f $dir/tags
    rm -f $dir/cscope*.out
    printf "Tagging %s ... " $dir
    ctags --langmap=c++:+.inc -a $dir/*
    ln -sf $PWD/tags $dir/tags
    echo "done!"
    all_dirs="$all_dirs $dir"
    num_dirs=$(expr $num_dirs + 1)
#    all_dirs_for_cscope="$all_dirs_for_cscope -s $dir"
  done
done
printf "Cscoping %i dirs ... " $num_dirs
#cscope -bRq $all_dirs_for_cscope
cscope -bRq
for dir in $all_dirs; do
  ln -sf $PWD/cscope*.out $dir/
done
echo "done!"
